# Massvision Web データベース設計書

## 1. データベース概要

### 1.1 使用するデータベース
- メインデータベース: PostgreSQL
- キャッシュ/セッション管理: Redis
- ファイルストレージ: MinIO

### 1.2 データベースの役割
- PostgreSQL: アプリケーションの主要データを永続化
- Redis: セッション管理、キャッシュ、リアルタイムデータの一時保存
- MinIO: プロジェクトファイル、画像などのバイナリデータの保存

## 2. テーブル設計

### 2.1 ユーザー管理テーブル

#### users
| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| id | UUID | NO | gen_random_uuid() | プライマリーキー |
| email | VARCHAR(255) | NO | - | メールアドレス（ユニーク） |
| password_hash | VARCHAR(255) | NO | - | パスワードハッシュ |
| name | VARCHAR(100) | NO | - | ユーザー名 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 更新日時 |

インデックス:
- PRIMARY KEY (id)
- UNIQUE INDEX idx_email (email)

### 2.2 プロジェクト管理テーブル

#### projects
| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| id | UUID | NO | gen_random_uuid() | プライマリーキー |
| user_id | UUID | NO | - | ユーザーID（外部キー） |
| name | VARCHAR(100) | NO | - | プロジェクト名 |
| description | TEXT | YES | NULL | プロジェクトの説明 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 更新日時 |

インデックス:
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- FOREIGN KEY (user_id) REFERENCES users(id)

### 2.3 シーン管理テーブル

#### scenes
| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| id | UUID | NO | gen_random_uuid() | プライマリーキー |
| project_id | UUID | NO | - | プロジェクトID（外部キー） |
| name | VARCHAR(100) | NO | - | シーン名 |
| count | INTEGER | NO | 0 | カウント数 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 更新日時 |

インデックス:
- PRIMARY KEY (id)
- INDEX idx_project_id (project_id)
- FOREIGN KEY (project_id) REFERENCES projects(id)

### 2.4 キャラクタ管理テーブル

#### characters
| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| id | UUID | NO | gen_random_uuid() | プライマリーキー |
| scene_id | UUID | NO | - | シーンID（外部キー） |
| position_x | INTEGER | NO | 0 | X座標 |
| position_y | INTEGER | NO | 0 | Y座標 |
| initial_direction | INTEGER | NO | 0 | 初期方向（0-315度） |
| macro_id | UUID | YES | NULL | マクロID（外部キー） |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 更新日時 |

インデックス:
- PRIMARY KEY (id)
- INDEX idx_scene_id (scene_id)
- INDEX idx_macro_id (macro_id)
- FOREIGN KEY (scene_id) REFERENCES scenes(id)
- FOREIGN KEY (macro_id) REFERENCES macros(id)

### 2.5 マクロ管理テーブル

#### macros
| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|----------|----------|------|--------------|------|
| id | UUID | NO | gen_random_uuid() | プライマリーキー |
| scene_id | UUID | NO | - | シーンID（外部キー） |
| content | TEXT | NO | - | マクロの内容 |
| variables | JSONB | YES | '{}' | 変数情報 |
| created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | 更新日時 |

インデックス:
- PRIMARY KEY (id)
- INDEX idx_scene_id (scene_id)
- FOREIGN KEY (scene_id) REFERENCES scenes(id)

## 3. Redis データ構造

### 3.1 セッション管理
```
Key: session:{session_id}
Type: Hash
Fields:
  - user_id: UUID
  - last_access: Timestamp
  - expires_at: Timestamp
```

### 3.2 キャッシュ
```
Key: cache:{resource_type}:{resource_id}
Type: String
Value: JSON
TTL: 1時間
```

### 3.3 リアルタイムデータ
```
Key: realtime:scene:{scene_id}
Type: Hash
Fields:
  - count: Integer
  - characters: JSON
```

## 4. MinIO バケット設計

### 4.1 バケット構成
- projects: プロジェクト関連ファイル
- scenes: シーン関連ファイル
- exports: エクスポートされたファイル

### 4.2 ファイル命名規則
```
projects/{project_id}/{filename}
scenes/{scene_id}/{filename}
exports/{export_id}/{filename}
```

## 5. データベース制約

### 5.1 制限値
- 1プロジェクトあたりのシーン数: 120
- 1シーンあたりのキャラクタ数: 128
- 1シーンあたりのマクロ数: 80
- 1マクロの最大長: 139文字
- 1シーンのカウント数: 64

### 5.2 インデックス戦略
- 頻繁に検索されるカラムにインデックスを設定
- 外部キー制約のあるカラムにインデックスを設定
- 複合インデックスは慎重に検討

### 5.3 パーティショニング戦略
- プロジェクトテーブル: ユーザーIDによるパーティショニング
- シーンテーブル: プロジェクトIDによるパーティショニング
- キャラクタテーブル: シーンIDによるパーティショニング

## 6. バックアップ戦略

### 6.1 バックアップ方式
- フルバックアップ: 週1回
- 差分バックアップ: 日1回
- トランザクションログ: リアルタイム

### 6.2 バックアップ保持期間
- フルバックアップ: 3ヶ月
- 差分バックアップ: 1ヶ月
- トランザクションログ: 1週間

### 6.3 リストア手順
1. 最新のフルバックアップをリストア
2. 差分バックアップを適用
3. トランザクションログを適用
4. 整合性チェックを実行 
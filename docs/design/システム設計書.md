# Massvision Web システム設計書

## 1. システムアーキテクチャ

### 1.1 全体構成
- フロントエンド（SPA）
- バックエンド（RESTful API）
- データベース
- ファイルストレージ
- WebSocketサーバー

### 1.2 コンポーネント構成
1. フロントエンド
   - React/Next.js
   - WebGL/Canvas描画エンジン
   - WebSocketクライアント
   - 状態管理（Redux/Zustand）

2. バックエンド
   - Node.js/Express
   - WebSocketサーバー
   - 認証・認可システム
   - バッチ処理システム

3. データベース
   - PostgreSQL
   - Redis（キャッシュ）

4. インフラ
   - AWS/GCP
   - CDN
   - ロードバランサー
   - バックアップシステム

## 2. モジュール設計

### 2.1 フロントエンドモジュール
1. プロジェクト管理モジュール
   - プロジェクトCRUD
   - シーン管理
   - ファイル管理

2. キャラクタ配置モジュール
   - 配置エンジン
   - 対称配置処理
   - 整列処理
   - コピー/移動処理

3. マクロ編集モジュール
   - マクロパーサー
   - 変数管理
   - マクロ実行エンジン
   - エラーチェック

4. アニメーションモジュール
   - アニメーションエンジン
   - タイムライン管理
   - トレース表示
   - プレビュー機能

5. リンクスライドモジュール
   - リンク処理
   - スライド計算
   - マクロ生成

6. 環境設定モジュール
   - 設定管理
   - ユーザー設定
   - システム設定

### 2.2 バックエンドモジュール
1. APIモジュール
   - RESTful API
   - WebSocket API
   - 認証API
   - ファイルAPI

2. データ処理モジュール
   - データ変換
   - バリデーション
   - エラーハンドリング
   - バッチ処理

3. ストレージモジュール
   - データベース操作
   - ファイル操作
   - キャッシュ管理
   - バックアップ

4. セキュリティモジュール
   - 認証
   - 認可
   - 暗号化
   - 監査ログ

## 3. データフロー

### 3.1 プロジェクト管理フロー
1. プロジェクト作成
   - ユーザー認証
   - プロジェクト初期化
   - メタデータ保存

2. シーン管理
   - シーン作成/編集
   - データ保存
   - バージョン管理

3. ファイル操作
   - インポート/エクスポート
   - バックアップ
   - 共有設定

### 3.2 アニメーション処理フロー
1. マクロ実行
   - マクロパース
   - 変数解決
   - 位置計算
   - アニメーション生成

2. リアルタイム処理
   - WebSocket通信
   - 状態同期
   - エラー通知

3. バッチ処理
   - 大量データ処理
   - バックグラウンド計算
   - 結果保存

## 4. セキュリティ設計

### 4.1 認証・認可
- JWT認証
- ロールベースアクセス制御
- セッション管理
- 2要素認証

### 4.2 データ保護
- データ暗号化
- 安全な通信（HTTPS）
- 入力バリデーション
- XSS/CSRF対策

### 4.3 監査・ログ
- アクセスログ
- 操作ログ
- エラーログ
- セキュリティイベント

## 5. パフォーマンス設計

### 5.1 最適化戦略
- キャッシュ戦略
- データベース最適化
- フロントエンド最適化
- CDN活用

### 5.2 スケーラビリティ
- 水平スケーリング
- 垂直スケーリング
- 負荷分散
- リソース管理

### 5.3 モニタリング
- パフォーマンスモニタリング
- エラーモニタリング
- リソース使用量
- アラート設定

## 6. エラーハンドリング

### 6.1 エラー種別
- システムエラー
- ビジネスロジックエラー
- バリデーションエラー
- ネットワークエラー

### 6.2 エラー処理
- エラーログ
- エラー通知
- リカバリー処理
- フォールバック

### 6.3 デバッグ
- デバッグモード
- ログレベル
- トレース機能
- エラー再現

## 7. 運用設計

### 7.1 デプロイメント
- CI/CD
- ブルー/グリーンデプロイ
- ロールバック
- バージョン管理

### 7.2 バックアップ
- 自動バックアップ
- リストア
- データ整合性
- 災害復旧

### 7.3 メンテナンス
- 定期メンテナンス
- アップデート
- パッチ適用
- 監視・監査

## 8. 追加・高度機能設計

### 8.1 UNDO/ヒストリUNDO
- 操作の多段階UNDO（回数指定・ディスク保存型）
- マクロ編集・配置・消去・初期方向設定などのUNDO
- ヒストリUNDOの最大回数指定・管理方法

### 8.2 特殊初期方向設定
- ベクトル方向、スライド方向、点座標方向の初期方向設定
- 外向き設定のUI・ロジック

### 8.3 マクロ終端子・コメント
- マクロ内での終端子（;）やコメント的記述のパース・無視処理

### 8.4 アニメファイル機能詳細
- 任意シーン連続再生のオーダー管理
- オーダー編集・保存・解除のUI/データ構造
- オート/マニュアル切替の状態管理

### 8.5 なめくじトレース
- キャラクタの軌跡表示アルゴリズム
- デバッグ用の軌跡可視化UI

### 8.6 バグ検出機能
- キャラクタ間距離の閾値設定・ON/OFF切替
- バグ検出時の警告・通知UI

### 8.7 リサイクル機能
- 既存配置の再利用ロジック
- シーン間の補完・再利用フロー

### 8.8 操作系の詳細
- キーボード/マウス/ショートカット/特殊キー対応の設計
- 範囲選択・複数選択のUI/ロジック
- 文字列編集の特殊キー対応

### 8.9 ファイル管理の詳細
- シーン・プロジェクトの移動/並べ替え/複数選択/範囲選択の設計
- 番号つけなおしのアルゴリズム

### 8.10 データ互換性・バージョン管理
- データの互換性維持のためのバージョン管理
- エクスポート/インポート時の変換処理

### 8.11 エラー時の挙動・リカバリ
- エラー発生時の通知・リカバリ手順
- データ破損時の自動検出・回復処理 
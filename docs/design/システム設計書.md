# Massvision Web システム設計書

## 1. システムアーキテクチャ

### 1.1 全体構成
```
[クライアント]
    ↓ HTTPS
[ロードバランサー]
    ↓
[Webサーバー群]
    ↓
[アプリケーションサーバー群]
    ↓
[データベース/ストレージ]
```

### 1.2 コンポーネント構成
1. フロントエンド
   - React/Next.js
   - Canvas描画エンジン
   - WebSocketクライアント
   - 状態管理（Redux/Zustand）

2. バックエンド
   - Node.js/Express
   - WebSocketサーバー
   - 認証サーバー
   - ファイルストレージ

3. データベース
   - PostgreSQL（メインデータベース）
   - Redis（キャッシュ/セッション管理）
   - MinIO（ファイルストレージ）

## 2. データモデル

### 2.1 エンティティ関係図
```
[User] 1---* [Project] 1---* [Scene] 1---* [Character]
[Scene] 1---* [Macro]
[Character] *---* [Macro]
```

### 2.2 主要エンティティ定義

#### User
- id: UUID
- email: String
- password_hash: String
- name: String
- created_at: DateTime
- updated_at: DateTime

#### Project
- id: UUID
- user_id: UUID (FK)
- name: String
- description: Text
- created_at: DateTime
- updated_at: DateTime

#### Scene
- id: UUID
- project_id: UUID (FK)
- name: String
- count: Integer
- created_at: DateTime
- updated_at: DateTime

#### Character
- id: UUID
- scene_id: UUID (FK)
- position_x: Integer
- position_y: Integer
- initial_direction: Integer
- macro_id: UUID (FK)
- created_at: DateTime
- updated_at: DateTime

#### Macro
- id: UUID
- scene_id: UUID (FK)
- content: Text
- variables: JSON
- created_at: DateTime
- updated_at: DateTime

## 3. API設計

### 3.1 RESTful API

#### 認証関連
```
POST /api/auth/register
POST /api/auth/login
POST /api/auth/logout
GET  /api/auth/me
```

#### プロジェクト関連
```
GET    /api/projects
POST   /api/projects
GET    /api/projects/:id
PUT    /api/projects/:id
DELETE /api/projects/:id
```

#### シーン関連
```
GET    /api/projects/:projectId/scenes
POST   /api/projects/:projectId/scenes
GET    /api/scenes/:id
PUT    /api/scenes/:id
DELETE /api/scenes/:id
```

#### キャラクタ関連
```
GET    /api/scenes/:sceneId/characters
POST   /api/scenes/:sceneId/characters
PUT    /api/characters/:id
DELETE /api/characters/:id
```

#### マクロ関連
```
GET    /api/scenes/:sceneId/macros
POST   /api/scenes/:sceneId/macros
PUT    /api/macros/:id
DELETE /api/macros/:id
```

### 3.2 WebSocket API

#### イベント
```
// キャラクタ移動
character:move
  - characterId: UUID
  - position: {x: number, y: number}

// アニメーション更新
animation:update
  - sceneId: UUID
  - count: number
  - characters: Array<{id: UUID, position: {x: number, y: number}}>

// リアルタイムコラボレーション
collaboration:update
  - userId: UUID
  - action: string
  - data: any
```

## 4. セキュリティ設計

### 4.1 認証・認可
- JWTベースの認証
- ロールベースのアクセス制御
- セッション管理

### 4.2 データ保護
- 通信の暗号化（HTTPS）
- パスワードのハッシュ化
- 入力値のバリデーション

### 4.3 アクセス制御
- プロジェクト単位のアクセス権限
- シーン単位の編集権限
- コラボレーション機能の権限管理

## 5. パフォーマンス設計

### 5.1 キャッシュ戦略
- Redisによるセッションキャッシュ
- CDNによる静的コンテンツ配信
- ブラウザキャッシュの活用

### 5.2 スケーリング
- 水平スケーリング（Webサーバー、アプリケーションサーバー）
- データベースのレプリケーション
- ロードバランシング

### 5.3 最適化
- 画像の最適化
- コードの分割
- 遅延ローディング

## 6. エラーハンドリング

### 6.1 エラーコード
- 400: バリデーションエラー
- 401: 認証エラー
- 403: 認可エラー
- 404: リソース未検出
- 500: サーバーエラー

### 6.2 エラーログ
- エラーの詳細な記録
- スタックトレースの保存
- エラー通知システム

## 7. 監視・運用設計

### 7.1 監視項目
- サーバーリソース使用率
- アプリケーションのレスポンスタイム
- エラー発生率
- アクティブユーザー数

### 7.2 バックアップ
- データベースの定期的バックアップ
- ファイルストレージのバックアップ
- バックアップの検証

### 7.3 デプロイメント
- CI/CDパイプライン
- ブルー/グリーンデプロイメント
- ロールバック手順 